<!DOCTYPE html>

<html lang="zh-Hant-TW">
    <head>
        
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title> Kotlin coroutine 基礎筆記 | 只放拖鞋的鞋櫃 </title>
	<meta property="og:title" content=" Kotlin coroutine 基礎筆記 | 只放拖鞋的鞋櫃 " />
	<meta name="twitter:title" content=" Kotlin coroutine 基礎筆記 | 只放拖鞋的鞋櫃 ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" Kotlin coroutine 基礎筆記 | 只放拖鞋的鞋櫃 ">
	<meta property="og:description" content=" Kotlin coroutine 基礎筆記 | 只放拖鞋的鞋櫃 " />
	<meta name="twitter:description" content=" Kotlin coroutine 基礎筆記 | 只放拖鞋的鞋櫃 " />

	<link rel="icon" type="image/x-icon" href="https://jchu.cc/assets/favicon.ico">

	<!--
	<link rel="image_src" href="" >
	<meta property="og:image" content="" />
	-->

	<link href="https://jchu.cc/atom.xml" title="只放拖鞋的鞋櫃" type="application/atom+xml" rel="alternative">

	<link rel="canonical" href="/2020/03/22-coroutine.html">

	<link rel="stylesheet" href="/asset/css/style.css">

    <link rel="stylesheet" href="/vendors/components-font-awesome/css/font-awesome.css">

    <meta name="generator" content="Hexo 5.4.0"></head>

    <body>
        
    <div class="layout-header">
        <header class="header">
            <div class="layout-logo">
                <div class="panel-logo">

                    <div class="box-logo">
                        <a href="/" title="只放拖鞋的鞋櫃"><img src="/assets/default_avatar.jpg" class="img-logo"></a>
                    </div>
                    <div class="box-main-title">
                        <h2><a href="/">Walkingice</a></h2>
                    </div>
                    <div class="box-sub-title">
                        
                            <p>Julian Chu, love Pixel-art and FF3. FOSS Developer. Co-founder of 0xLab. Join g0v.</p>
                        
                    </div>
                </div>
            </div>

            <div class="layout-menu-container">

<div class="layout-menu">
    <div class="menu-group">
        <nav>
            <ul class="menu-list">
                
                <li class="menu-item">
                    <a href="/">
                        <i class="fa fa-home gutter-right menu-icon"></i>
                        <span class="menu-item">首頁</span>
                    </a>
                </li>
                
                
                <li class="menu-item">
                    <a href="/archives">
                        <i class="fa fa-archive gutter-right"></i>
                        <span class="menu-item">文章彙整</span>
                    </a>
                </li>
                
                
                <li class="menu-item">
                    <a href="/atom.xml">
                        <i class="fa fa-rss-square gutter-right"></i>
                        <span class="menu-item">RSS</span>
                    </a>
                </li>
                
            </ul>
        </nav>
    </div>

    
    <div class="menu-group">
        <div class="menu-list">
        
            <div class="menu-item">
                <a href="/lamejokes" target="_blank">
                    
                        <i class="fa fa-comment gutter-right"></i>
                    
                冷言冷語
                </a>
            </div>
        
            <div class="menu-item">
                <a href="https://github.com/g0v" target="_blank">
                    
                        <i class="fa fa-compass gutter-right"></i>
                    
                g0v
                </a>
            </div>
        
        </div>
    </div>
    

    
    <div class="extra-comments">
        <div>本站無留言功能，有問題或發現錯誤，歡迎到<a target="_blank" rel="noopener" href="https://twitter.com/walkingice">twitter</a>戳我，謝謝</div>
    </div>
    

    
    <div class="menu-group deflinks">
        <div class="menu-list text-center">
            
            <a href="https://github.com/walkingice" target="_blank">
                <i class="fa fa-github-square gutter-right menu-icononly"></i>
            </a>
            

            
            <a href="https://twitter.com/walkingice" target="_blank">
                <i class="fa fa-twitter-square gutter-right menu-icononly"></i>
            </a>
            

            

            

            

            

            

        </div>
    </div>
    
</div>

</div>

 
        </header>
    </div>

        <div class="layout-content">
            
<div class="row panel-content">
    

    <div class="article-wrap">
        <article class="content" itemscope itemtype="http://schema.org/Article" >
    <h1 class="article-title">
        <a href="/2020/03/22-coroutine.html" itemprop="url" target="_blank">
            <span class="">Kotlin coroutine 基礎筆記</span>
        </a>
    </h1>

    <p>Coroutine 算是 Kotlin 裡面相當引人注目的功能，簡單來說就是可以幫助處理非同步需求的機制。</p>
<p>舉例來說，我們常常看到這樣的需求：按下一個 Fetch 的按鈕，去抓網路上的某個列表來更新手機內的資料，同時又不希望 UI thread 被卡住。在 Android 上面經常就是祭出 AsyncTask，或是用 Rx 的方式來處理。利用 Coroutine，這些功能都會變得比較簡單實作</p>
<span id="more"></span>

<p>Coroutine 用起來很簡單，但是鑽進去實作之後發現裡面錯綜複雜，很多東西看到後面我開始懷疑自己的理解，甚至要懷疑自己人生。這邊只會記錄我的粗淺理解，不寫下來就很容易忘記，未來還會繼續更新這裡。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/@elizarov/coroutine-context-and-scope-c8b255d59055">Coroutine Context and Scope - Roman Elizarov</a> - Kotlin libraries Tech Lead 寫的文章，同樣還有好多篇都值得看一下</li>
<li><a target="_blank" rel="noopener" href="https://proandroiddev.com/demystifying-coroutinecontext-1ce5b68407ad">Demystifying CoroutineContext</a> - 這篇也有講到一些內部實作的東西，值得看一下</li>
<li><a target="_blank" rel="noopener" href="https://blog.youxu.info/2014/12/04/coroutine/">协程的历史，现在和未来</a> - 習慣用 thread 的人，很推薦看一下這篇故事，了解 coroutine 的起源</li>
</ul>
<blockquote>
<p>最早提出“协程”概念的 Melvin Conway 的出发点，也是如何写一个只扫描一遍程序 (one-pass) 的 COBOL 编译器….<br>在 Conway 的设计里，词法和语法解析不再是两个独立运行的步骤，而是交织在一起。编译器的控制流在词法和语法解析之间来回切换…<br>简言之，协程的全部精神就在于控制流的主动让出和恢复</p>
</blockquote>
<p>我們知道 Process 跟 Thread 的切換由作業系統負責，執行一段時間的程式碼被作業系統中斷，切換到另外一個 Process 或是 Thread。而 Coroutine 的精神則是程式碼執行到一個程度時，向 Scheduler 說：「我 OK，<del>你先領</del>下一位」。這部份的調度發生在 user space 裡面，從作業系統的角度來看，看不見「切換 coroutine」這件事情。</p>
<p>用比較不精確的想像，就是 Kotlin 利用了 syntax sugar 讓你寫出看似循序執行的程式碼，但是實際上程式碼被切碎許多叫做 coroutine 的單位，放進叫做 Scope 的資料結構裡面。這些 coroutines 依照能夠被預測的順序放進 thread 裡面執行。</p>
<p>用一開頭的例子，按下 fetch 鈕之後，透過 <code>launch</code> 產生一個 coroutine，繁重的工作放在裡面，所以最後那行 log 能在 coroutine 的工作完成以前就被執行到。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fetchButton.onClickListener &#123; view -&gt;</span><br><span class="line">    currentScope.launch &#123;</span><br><span class="line">        <span class="keyword">val</span> list = fetchListFromServer()</span><br><span class="line">        updateLocal(list)</span><br><span class="line">    &#125;</span><br><span class="line">    Log.d(<span class="string">&quot;button clicked&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>「產生一個 coroutine」這句話困擾了我很久，到底產生了什麼東西？在 <code>Builders.common.kt</code> 裡面可以窺見</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">launch</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    context: <span class="type">CoroutineContext</span> = EmptyCoroutineContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    start: <span class="type">CoroutineStart</span> = CoroutineStart.DEFAULT,</span></span></span><br><span class="line"><span class="params"><span class="function">    block: <span class="type">suspend</span> <span class="type">CoroutineScope</span>.() -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: Job &#123;</span><br><span class="line">    <span class="keyword">val</span> newContext = newCoroutineContext(context)</span><br><span class="line">    <span class="keyword">val</span> coroutine = <span class="keyword">if</span> (start.isLazy)</span><br><span class="line">        LazyStandaloneCoroutine(newContext, block) <span class="keyword">else</span></span><br><span class="line">        StandaloneCoroutine(newContext, active = <span class="literal">true</span>)</span><br><span class="line">    coroutine.start(start, coroutine, block)</span><br><span class="line">    <span class="keyword">return</span> coroutine</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LazyStandaloneCoroutine</code> <code>StandaloneCoroutine</code> 就是生出的 Coroutine，我們包在 launch 裡面的那些程式碼，就是 <code>block</code></p>
<h3 id="CoroutineScope-CoroutineContext"><a href="#CoroutineScope-CoroutineContext" class="headerlink" title="CoroutineScope / CoroutineContext"></a>CoroutineScope / CoroutineContext</h3><p>追程式碼的時候會不斷看到這幾個詞，追程式碼的時候甚至看到 CoroutineScope 就是超簡單的 interface，直接包著 CoroutineContext</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CoroutineScope</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> coroutineContext: CoroutineContext</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>兩者看起來幾乎等價。Roman 的講法是：「The difference between a context and a scope is in their intended purpose.」，我目前的理解為</p>
<ul>
<li>CoroutineContext 用來提供每個 Coroutine 執行的資訊 (Job, CoroutineExceptionHandler…這些實作 CoroutineContext.Element 的類別)</li>
<li>CoroutineScope 定義了 coroutines 之間的階層關係，透過 CoroutineScope 的 functions 建構 coroutine 的同時，也會把 parent-child 關係安排好</li>
</ul>
<div style="max-width: 500px; margin: auto;"><img src="/2020/03/22-coroutine/coroutine_scopes_by_elizavor.png" class="" title="source:https:&#x2F;&#x2F;medium.com&#x2F;@elizarov&#x2F;coroutine-context-and-scope-c8b255d59055"></div>

<p>借用一下 Roman 的圖。Kotlin Coroutine 的實作用了大量的 extension functions，最常用的 <code>CoroutineScope.launch</code> 也是其一。上圖可以看到 Parent 包著 Child scope，這也是 scope 的重要特性：當 Parent scope 被取消的時候，child scope 也會一併被取消。</p>
<p>上面還有個重要的訊息，就是從 context <code>A</code> launch 一個新的 coroutine <code>B</code>，但是 <code>B</code> 的 parent context 不一定是 <code>A</code>。因為 launch 能指定 additional context (也就是 function signature 裡面的 <code>context</code>)，這也可能成為 parent-context。這也是為什麼 launch function 的預設 context 是 <code>EmptyCoroutineContext</code>。</p>
<h3 id="GlobalScope"><a href="#GlobalScope" class="headerlink" title="GlobalScope"></a>GlobalScope</h3><p>前面提到了 parent scope 停掉的時候，child scope 也會停掉，所以確認你的 coroutine 掛在正確的 scope 底下很重要。尤其 Android 裡面，經常有 Activity/Fragment 被關掉的機會，如果畫面都被關掉了，有些操作就該被停止。</p>
<p>所以 Android architecture 就提供了幾個 <a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/architecture/coroutines">coroutine scope</a> 幫你處理瑣事。只要是從正確的 scope 發起的 coroutine，在 Activity / Fragment 關閉的時候，會記得幫你取消 child scope 裡面的 coroutine</p>
<p>而 <code>GlobalScope</code> 則是一個 singleton class，它的生命週期會長於 activity，沒有很確定自己在做什麼，盡量不要透過它生出 coroutine。</p>
<h3 id="Suspend-function"><a href="#Suspend-function" class="headerlink" title="Suspend function"></a>Suspend function</h3><p><code>suspend</code> 本身只是一個 modifier，實作放在 Suspend.kt 裡面。會由 compiler <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/47871868/what-does-suspend-function-mean-in-kotlin-coroutine/52925057#52925057">做真正的工作</a>，把標示 suspend 的 function 轉成另外一個樣子，將 <code>Continuation&lt;T&gt;</code> 塞進 function signature 裡面。</p>
<p>實作的運作邏輯我還沒摸清楚，只從使用的角度來看，標示了 <code>suspend</code> 的 function，意思就是執行到這個 function 的時候，能夠讓出控制流給其他 coroutine。也就是這些 function 都會說：「我 OK，(有需要的話)你先請」，自己走到後面重新排隊</p>
<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><p>來看一點簡單的範例</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">println(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">launch &#123;</span><br><span class="line">    println(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">println(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">launch &#123;</span><br><span class="line">    println(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">println(<span class="string">&quot;3&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>每個 <code>launch</code> 會產生一個新的 coroutine 排在後面執行，由於沒有 suspend function 被呼叫，缺少讓出控制流的機會，因此執行程式後會依序印出數字 <code>1 2 3 4 5</code>。</p>
<p>Kotlin Coroutine 官方提供了 <code>runTest</code> 這個工具，讓開發者可以輕鬆地在每個單元測試裡面呼叫 suspend function，彷彿被 runBlocking 包起來，確保 unit test 結束的時候，每個 scope 裡面的 coroutine 也有執行完畢。</p>
<p>底下是利用 <code>runtTest</code> 的簡單範例。因為 foo 是 suspend function，執行到 <code>delay</code> 會讓出控制權，所以印出來的數字會是 <del><code>1 2 3 4 foo 5 6</code></del> <code>1 2 3 4 5 foo 6</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">suspendTest</span><span class="params">()</span></span> = runTest &#123;</span><br><span class="line">    println(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    launch &#123;</span><br><span class="line">        println(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">        foo(<span class="string">&quot;foo&quot;</span>)</span><br><span class="line">        println(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    launch &#123;</span><br><span class="line">        println(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">(param: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    delay(<span class="number">1</span>)</span><br><span class="line">    println(param)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果把情況弄得再複雜一點</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">traceSequence</span><span class="params">()</span></span> = runTest &#123;</span><br><span class="line">    println(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    launch &#123;</span><br><span class="line">        println(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">        foo(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">        println(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">        foo(<span class="string">&quot;c&quot;</span>)</span><br><span class="line">        println(<span class="string">&quot;10&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    launch &#123;</span><br><span class="line">        println(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">        foo(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">        println(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    launch &#123;</span><br><span class="line">        println(<span class="string">&quot;7&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>印出來的結果會是 <code>1 2 3 4 5 6 7 a 8 b 9 c 10</code>，印出 “c” 之前那個 coroutine 會讓出控制權，讓 “b” 先被印出</p>
<p>前面的結果可以觀察到，coroutine 雖然讓程式碼的執行變成非同步，但是運作的順序還是可以預測，不像 thread 或 process。coroutine 的概念就像是排隊買口罩，某一家的人可能會跑到隊伍後面重新排起。</p>
<p>這又引入了另外一個問題，如果我產生了兩個 coroutines，它們都很溫馨地跑到隊伍後面重排，但是排在前面的 coroutine 動作很慢的話，會不會卡到後面的？</p>
<p>我在 local 跑起了一個 server，向它發 GET request 會等五秒才回應，接著寫了一個非 suspend function</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 這個 function 會花五秒才 return</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getRemoteServer</span><span class="params">(param: <span class="type">String</span> = <span class="string">&quot;?&quot;</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> url = URL(<span class="string">&quot;http://localhost:8000/&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> urlConnection: HttpURLConnection = url.openConnection() <span class="keyword">as</span> HttpURLConnection</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        BufferedInputStream(urlConnection.inputStream).read()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        urlConnection.disconnect()</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">&quot;done(<span class="variable">$param</span>)&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">traceRemoteCall</span><span class="params">()</span></span> &#123;</span><br><span class="line">    runBlocking &#123;</span><br><span class="line">        println(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">        launch &#123;      <span class="comment">// coroutine a</span></span><br><span class="line">            println(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">            getRemoteServer(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">            println(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        println(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">        launch &#123;      <span class="comment">// coroutine b</span></span><br><span class="line">            println(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">            getRemoteServer(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">            println(<span class="string">&quot;7&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        println(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最後印出的結果是 <code>1 2 3 4 done(a) 5 6 done(b) 7</code> 耗時 10 秒。雖然 3 很快地被印出來，但是 a 的動作很慢，一定要跑完 coroutine a 才有機會跑到 6</p>
<p>如果把 getRemoteServer 換成 suspend function 並且跑在別的 dispatcher 底下，情況就變得更複雜了。以後有空再寫吧</p>
<p>20240730 Update: 感謝<a target="_blank" rel="noopener" href="https://twitter.com/KJackal">Jackal</a>同學的提醒，修正 Example 2 的錯誤輸出</p>


    
</article>


        <div class="article-meta content">
    <div class="groups">
        <span class="group">
            <a class="archive-item-date" href="https://jchu.cc/2020/03/22-coroutine.html">
                <i class="fa fa-calendar"></i>
                <span
                    itemprop="datePublished"
                    content="2020-03-22">2020-03-22</span>
            </a>
        </span>

        <span class="group">
            
            
                <a href="/categories/geek/">
                    <i class="fa fa-th"></i>
                    <span class="">geek</span>
                </a>
            
        </span>

        <span class="group float-right">
            
            
                <a href="/tags/android/">
                    <span class="tag">android</span>
                </a>
            
                <a href="/tags/kotlin/">
                    <span class="tag">kotlin</span>
                </a>
            
        </span>
    </div>

</div>



    </div>

    <div class="panel-post-nav">
        <div class="box-post-nav">
            
                <a class="btn" href="/2020/08/16-twofactor.html" title="實作 Google Authenticator 的兩階段驗證"><b>實作 Google Authenticator 的兩階段驗證</b> &larr; Prev</a>
            
            
                <a class="btn" href="/2019/12/19-gwent.html" title="Witcher 3 昆特牌基本教學">Next &rarr; <b>Witcher 3 昆特牌基本教學</b></a>
            
        </div>
    </div>
</div>


        </div>
        
<div class="layout-footer" style="clear: both">
    <div class="panel-footer">
        <div class="box-footer">
            <footer class="footer">
                
                <a target="_blank" rel="noopener" href="http://creativecommons.org/">
                    License: <i class="fa fa-cc"></i> by-nc-sa
                </a>
                
                <p class="theme">Powered by
                    <a href="http://hexo.io/" target="_blank">Hexo</a>,
                    Theme
                    <a href="https://github.com/walkingice/hexo-theme-kaku" target="_blank">Kaku</a>
                </p>
            </footer>
        </div>
    </div>
</div>

<div class="layout-menu-footer">
    <div class="layout-menu-container">

<div class="layout-menu">
    <div class="menu-group">
        <nav>
            <ul class="menu-list">
                
                <li class="menu-item">
                    <a href="/">
                        <i class="fa fa-home gutter-right menu-icon"></i>
                        <span class="menu-item">首頁</span>
                    </a>
                </li>
                
                
                <li class="menu-item">
                    <a href="/archives">
                        <i class="fa fa-archive gutter-right"></i>
                        <span class="menu-item">文章彙整</span>
                    </a>
                </li>
                
                
                <li class="menu-item">
                    <a href="/atom.xml">
                        <i class="fa fa-rss-square gutter-right"></i>
                        <span class="menu-item">RSS</span>
                    </a>
                </li>
                
            </ul>
        </nav>
    </div>

    
    <div class="menu-group">
        <div class="menu-list">
        
            <div class="menu-item">
                <a href="/lamejokes" target="_blank">
                    
                        <i class="fa fa-comment gutter-right"></i>
                    
                冷言冷語
                </a>
            </div>
        
            <div class="menu-item">
                <a href="https://github.com/g0v" target="_blank">
                    
                        <i class="fa fa-compass gutter-right"></i>
                    
                g0v
                </a>
            </div>
        
        </div>
    </div>
    

    
    <div class="extra-comments">
        <div>本站無留言功能，有問題或發現錯誤，歡迎到<a target="_blank" rel="noopener" href="https://twitter.com/walkingice">twitter</a>戳我，謝謝</div>
    </div>
    

    
    <div class="menu-group deflinks">
        <div class="menu-list text-center">
            
            <a href="https://github.com/walkingice" target="_blank">
                <i class="fa fa-github-square gutter-right menu-icononly"></i>
            </a>
            

            
            <a href="https://twitter.com/walkingice" target="_blank">
                <i class="fa fa-twitter-square gutter-right menu-icononly"></i>
            </a>
            

            

            

            

            

            

        </div>
    </div>
    
</div>

</div>


</div>



<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://stats.timdream.org/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '13']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->








    </body>
</html>
